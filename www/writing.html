<!DOCTYPE HTML>
<!--
	Verti by HTML5 UP
	html5up.net | @n33co
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
		<title>Jot - Crowdsourced Authoring</title>
		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
		<meta name="description" content="" />
		<meta name="keywords" content="" />
		<!--[if lte IE 8]><script src="css/ie/html5shiv.js"></script><![endif]-->
		<script src="js/jquery.min.js"></script>
		<script src="js/jquery.dropotron.min.js"></script>
		<script src="js/skel.min.js"></script>
		<script src="js/skel-layers.min.js"></script>
		<script src="js/init.js"></script>
		<script src="js/parse/parse-1.2.19.js"></script>
		<script src="js/parse/functions.js"></script>
		<noscript>
			<link rel="stylesheet" href="css/skel.css" />
			<link rel="stylesheet" href="css/style.css" />
			<link rel="stylesheet" href="css/style-desktop.css" />
		</noscript>
		<!--[if lte IE 8]><link rel="stylesheet" href="css/ie/v8.css" /><![endif]-->
		<script src='https://cdn.firebase.com/js/client/1.0.15/firebase.js'></script>
		<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js'></script>
	</head>
	<body class="homepage">

		<!-- Header -->
			<div id="header-wrapper">
				<header id="header" class="container">

					<!-- Logo -->
						<div>
							<img src="./images/logo.png" height="150" width="150">
							<h1>Create. Write. Publish. Print.</h1>
							<span>A <i>novel</i> way to write books.</span>
						</div>

					<!-- Nav -->
						<nav id="nav">
							<ul>
								<li><a href="index.html">Home</a></li>
								<li>
									<a href="">Catalog</a>
									<ul>
										<li><a href="#">All</a></li>
										<li><a href="#">Fiction</a></li>
										<li><a href="#">Non-Fiction</a></li>
										<li><a href="#">Action</a></li>
										<li><a href="#">Adventure</a></li>
										<li><a href="#">Mystery</a></li>
										<li><a href="#">Romance</a></li>
									</ul>
								</li>
								<li><a href="profile.html">Profile</a></li>
								<li class="current"><a href="writing.html">Write</a></li>
								<li><a href="create.html">Sign Up</a></li>
							</ul>
						</nav>

				</header>
			</div>

		<!-- Writing Posts -->
		<div id="messagesDiv"></div>
		<div id="banner-wrapper">
			<div id="banner" class="box container" style="padding: 1em">
				<div class="row">
					<div class="12u">
							<textarea name="newPost" id="newPost" placeholder="Type next paragraph here..." rows="4f"></textarea>
							<center>
								<div class="4u">
									<a class="button" id="submitButton">Submit</a>
								</div>
							</center>
					</div>
				</div>
			</div>
		</div>
		<br>

		<!-- Firebase Code -->
		<script>
			var guid = (function() {
				function s4() {
					return Math.floor((1 + Math.random()) * 0x10000)
						.toString(16)
						.substring(1);
				}
				return function() {
					return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
					s4() + '-' + s4() + s4() + s4();
				};
			})();

			var myDataRef = new Firebase('https://radiant-inferno-4410.firebaseio.com/posts');
			var myVotesDataRef = new Firebase('https://radiant-inferno-4410.firebaseio.com/votes');

			$('#submitButton').click(function (e) {
					var user = Parse.User.current();
					user.fetch().then(function(fetchedUser){
						var name = fetchedUser.getUsername();
						var text = $('#newPost').val();
						var votes = 0;
						var postGuid = guid();
						var picture = JSON.stringify(Parse.User.current().get("picture"));
						if (!picture) {
							myDataRef.push({username: name, text: text, votes: votes, picture: "http://i.imgur.com/lUMup57.png?1"});
						} else {
							myDataRef.push({username: name, text: text, votes: votes, picture: picture});
						}

						$('#newPost').val('');
					}, function(error){
						//Handle the error
						alert("Authentication error. Please sign in to post.");
					});
			});

			myDataRef.on('child_added', function(snapshot) {
				var message = snapshot.val();
				var postGuid = snapshot.name();

				// Add the vote data for the posting user
				myVotesDataRef.child(postGuid).once('value', function(vote_snapshot) {
					var hasVoted = vote_snapshot.child('voted').val();
					if (hasVoted != null) {
					 	myVotesDataRef.child(postGuid).set({username: message.username, voted: hasVoted});
					} else {
					 	myVotesDataRef.child(postGuid).set({username: message.username, voted: false});
					}
				});

				displayPosts(message.username, message.text, message.votes, postGuid, message.picture);
			});

			function displayPosts(username, text, votes, postGuid, picture) {
				$('#messagesDiv').append(''+
				'<div id="container-'+postGuid+'">'+
				'<div id="features-wrapper">'+
					'<div class="container">'+
						'<div class="row">'+
							'<div class="2u">'+
								'<center>'+
									'<div class="box feature" style="padding: 1em"><a><i value="'+postGuid+'" class="button fa fa-arrow-circle-o-up fa-2x"></i></a><p><font id="vote'+postGuid+'" size="6">'+votes+'</font></p><i value="'+postGuid+'" class="button fa fa-arrow-circle-o-down fa-2x"></i></div>'+
								'</center>'+
							'</div>'+

							'<div class="10u">'+
								'<div class="box feature" style="padding: 1em"><a style="cursor:pointer"><i value="'+postGuid+'" class="fa fa-plus-circle fa-2x" style="float: right;"></i></a>'+
									'<img src='+picture+' height="50px" width="50px"/><br>'+username+'<hr>'+
									'<br><strong>'+text+"</strong>"+
								'</div>'+
							'</div>'+
						'</div>'+
					'</div>'+
				'</div>'+
				'</div>');

				$('#messagesDiv')[0].scrollTop = $('#messagesDiv')[0].scrollHeight;
			};

			// Up vote button has been clicked
			$('body').on('click', '.fa-arrow-circle-o-up', function() {
  			var postGUID = $(this).attr('value');
				var voteCurrentValue = $('#vote' + postGUID).text();

				// If userVoted == false, then upvote
				var myVotesDataRef = new Firebase('https://radiant-inferno-4410.firebaseio.com/votes');
				myVotesDataRef.child(postGUID).once('value', function(snapshot) {
					var hasVoted = snapshot.child('voted').val();
					if (!hasVoted) {
						// Set firebase hasVoted to true
						myVotesDataRef.child(postGUID).child('voted').set(true);
						// Set num of votes up one
						var myPostsDataRef = new Firebase('https://radiant-inferno-4410.firebaseio.com/posts');
						var newVoteCount = Number(voteCurrentValue)+1;
						myPostsDataRef.child(postGUID).child('votes').set(newVoteCount);
						$('#vote' + postGUID).text(newVoteCount);
					}
				});
			});

			// Down vote button has been clicked
			$('body').on('click', '.fa-arrow-circle-o-down', function() {
				var postGUID = $(this).attr('value');
				var voteCurrentValue = $('#vote' + postGUID).text();

				// If userVoted == false, then downvote
				var myVotesDataRef = new Firebase('https://radiant-inferno-4410.firebaseio.com/votes');
				myVotesDataRef.child(postGUID).once('value', function(snapshot) {
					var hasVoted = snapshot.child('voted').val();
					if (!hasVoted) {
						// Set firebase hasVoted to true
						myVotesDataRef.child(postGUID).child('voted').set(true);
						// Set num of votes down one
						var myPostsDataRef = new Firebase('https://radiant-inferno-4410.firebaseio.com/posts');
						var newVoteCount = Number(voteCurrentValue)-1;
						myPostsDataRef.child(postGUID).child('votes').set(newVoteCount);
						$('#vote' + postGUID).text(newVoteCount);
					}
				});
			});

			// Plus button has been clicked
			$('body').on('click', '.fa-plus-circle', function() {
				var postGuid = $(this).attr('value');
				$('#container-'+postGuid).append(''+
				'<div id="banner-wrapper-new">'+
					'<div id="banner" class="box container" style="padding: 1em">'+
						'<div class="row">'+
							'<div class="12u">'+
									'<textarea name="nextNewPost" id="nextNewPost" placeholder="Type next paragraph here..." rows="4f"></textarea>'+
									'<center>'+
										'<div class="4u">'+
											'<a class="button" id="newSubmitButton" onclick="submitNextPost()">Submit</a>'+
										'</div>'+
									'</center>'+
							'</div>'+
						'</div>'+
					'</div>'+
				'</div>'+
				'<br>');
			});

			function submitNextPost() {
					var user = Parse.User.current();
					user.fetch().then(function(fetchedUser){
						var name = fetchedUser.getUsername();
						var text = $('#nextNewPost').val();
						var votes = 0;
						var postGuid = guid();
						var picture = JSON.stringify(Parse.User.current().get("picture"));
						if (!picture) {
							myDataRef.push({username: name, text: text, votes: votes, picture: "http://i.imgur.com/lUMup57.png?1"});
						} else {
							myDataRef.push({username: name, text: text, votes: votes, picture: picture});
						}
						$('#banner-wrapper-new').remove();
					}, function(error){
						//Handle the error
						alert("Authentication error. Please sign in to post.");
					});
			}
		</script>

		<!-- parse code -->
		<script>
			$(window).load(function() {
				Parse.initialize("zZBe1MJTg2fRmx62W2jJgEpSaTczz5kEdUV3tEvY", "q9XV1z0y1YAHI8aGtWFKD3UkPIkwRaOPtFLVwOWF");
			});
		</script>
	</body>
</html>
